#!/usr/bin/env ruby

#--------------------
# Convert LDAP information to Nagios configurations

require 'getoptlong'

# a small hack; yay
begin
	require 'nagios.rb'
	require 'nagios/ldap.rb'
rescue LoadError
	puts "duh: export RUBYLIB=~/cvs/nagios/generation/lib/ruby/"
	exit
end

result = GetoptLong.new(
	[ "--help",		"-h",            GetoptLong::NO_ARGUMENT ]
)

filter = ARGV[0]

entries = []

begin
	ldap_conn = LDAP::Conn.new("localhost", 389)
	ldap_conn.set_option(LDAP::LDAP_OPT_PROTOCOL_VERSION, 3)
	ldap_conn.bind{
		ldap_conn.search("dc=madstop,dc=com", LDAP::LDAP_SCOPE_SUBTREE, filter){ |entry|
			object = entry.entry2nagios
			entries.push(object)
		}
	}
rescue LDAP::ResultError => msg
	print(msg)
rescue Exception => ex
	puts ex
end

entries.each{ |obj|
	puts obj
}

# $Id: ldap2nag,v 1.1 2004/06/09 20:32:40 luke Exp $
